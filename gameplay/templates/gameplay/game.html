{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}Hra {{ game.id }}{% endblock %}

{% block content %}
<div id="quote-overlay" class="hidden">
    <div class="quote-text">‚ÄûNa poƒç√°tku bylo Slovo‚Ä¶‚Äú ‚Äì Jan 1:1</div>
</div>

<script>
    function showQuote() {
        const overlay = document.getElementById('quote-overlay');
        const quote = overlay.querySelector('.quote-text');

        overlay.classList.add('visible');
        setTimeout(() => quote.style.opacity = 1, 1500);
        setTimeout(() => quote.style.opacity = 0, 4500);
        setTimeout(() => overlay.classList.remove('visible'), 6000);
    }
</script>

<div class="game-wrapper">

    <h1>Hr√°ƒç: {{ game.player.username }}</h1>

    <h2>Hern√≠ m≈ô√≠≈æka</h2>
    <div class="sudoku-grid">
        {% for cell in cells %}
            <div class="cell
                {% if cell.column in grid_borders %} grid-border{% endif %}
                {% if cell.row in grid_borders %} grid-border{% endif %}">
                {% if cell.selected_item %}
{% if cell.selected_item %}
    {% if game.difficulty == 'easy' %}
        <span class="{% if cell.is_correct %}correct-number{% else %}incorrect-number{% endif %}">
            {{ cell.selected_item.number }}
        </span>
    {% else %}
        <span class="neutral-number">
            {{ cell.selected_item.number }}
        </span>
    {% endif %}
{% endif %}
                {% endif %}
            </div>
        {% endfor %}
    </div>
<div class="room-navigation">
    <h3>Dve≈ôe do sousedn√≠ch m√≠stnost√≠:</h3>
    <div class="door-links">
        {% if neighbors.up %}
            <a href="#" onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id neighbors.up %}')">üîº Nahoru</a>
        {% endif %}
        {% if neighbors.down %}
            <a href="#" onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id neighbors.down %}')">üîΩ Dol≈Ø</a>
        {% endif %}
        {% if neighbors.left %}
            <a href="#" onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id neighbors.left %}')">‚óÄÔ∏è Vlevo</a>
        {% endif %}
        {% if neighbors.right %}
            <a href="#" onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id neighbors.right %}')">‚ñ∂Ô∏è Vpravo</a>
        {% endif %}
    </div>
</div>
    <h2>Vybran√Ω blok</h2>
    <div class="sudoku-block">
        {% for cell in selected_block %}
<div class="block-cell
    {% if cell.prefilled %}
        locked
        {% if game.difficulty == 'easy' %}
            correct
        {% else %}
            prefilled-gray
        {% endif %}
    {% else %}
        {% if cell.selected_item %}
            {% if game.difficulty == 'easy' %}
                {% if cell.is_correct %} correct{% else %} incorrect{% endif %}
            {% else %}
                filled
            {% endif %}
        {% endif %}
    {% endif %}"
        {% if not cell.prefilled %}
        onclick="placeItem({{ cell.id }}, {% if cell.selected_item %}{{ cell.selected_item.number }}{% else %}-1{% endif %})"
    {% endif %}>
    {% if cell.selected_item %}
        {{ block_item_names|get_item:cell.selected_item.number|default:cell.selected_item.number }}
    {% endif %}
</div>
        {% endfor %}
    </div>
    <h2>Vyber p≈ôedmƒõt v m√≠stnosti: {{ room_name }}</h2>
    <div>
        {% for item in items %}
            <button class="item-btn" data-number="{{ item.number }}" onclick="selectItem({{ item.number }})">
                {{ item.name }}
            </button>
        {% endfor %}
    </div>

    <div class="block-selector">
        <p>Vyber blok:</p>
        {% for i in block_range %}
            <a href="#" onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id i %}')" class="{% if i == block_index %}active{% endif %}">
                Blok {{ i }}
            </a>
        {% endfor %}
    </div>

    <a href="{% url 'start_new_game' %}" onclick="return confirmNewGame();">
        Spustit novou hru
    </a>

    <button onclick="transitionTo('/gameplay/{{ game.id }}/block/1/')">TEST FADE</button>
    <button onclick="showQuote()">Zobraz citaci</button>

</div>

<script>
    let selectedNumber = null;

    function selectItem(number) {
        selectedNumber = number;
        document.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('selected'));
        document.querySelectorAll(`.item-btn[data-number="${number}"]`).forEach(btn => btn.classList.add('selected'));
    }

    function placeItem(cellId, currentItemNumber) {
        let numberToSend = selectedNumber !== null ? selectedNumber : -1;

        if (currentItemNumber === selectedNumber) {
            numberToSend = -1;
        }

        fetch(`/gameplay/place/${cellId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ number: numberToSend })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "completed") {
                window.location.href = "/gameplay/win/";
            } else {
                location.reload();
            }
        })
        .catch(error => console.error("Error communicating with server:", error));
    }

    function confirmNewGame() {
        return confirm("‚ö†Ô∏è Opravdu chce≈° spustit novou hru? Tvoje aktu√°ln√≠ hra bude smaz√°na!");
    }
</script>
{% endblock %}
