{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}Hra {{ game.id }}{% endblock %}

{% block content %}
<div id="quote-overlay" class="hidden">
    <div class="quote-text">„Na počátku bylo Slovo…“ – Jan 1:1</div>
</div>

<script>
    function showQuote() {
        const overlay = document.getElementById('quote-overlay');
        const quote = overlay.querySelector('.quote-text');

        overlay.classList.add('visible');
        setTimeout(() => quote.style.opacity = 1, 1500);
        setTimeout(() => quote.style.opacity = 0, 4500);
        setTimeout(() => overlay.classList.remove('visible'), 6000);
    }
</script>

<div class="game-wrapper">

    <h1>Hráč: {{ game.player.username }}</h1>

    <h2>Herní mřížka</h2>
    <div class="sudoku-grid">
        {% for cell in cells %}
            <div class="cell
                {% if cell.column in grid_borders %} grid-border{% endif %}
                {% if cell.row in grid_borders %} grid-border{% endif %}">
                {% if cell.selected_item %}
                    <span class="{% if cell.is_correct %}correct-number{% else %}incorrect-number{% endif %}">
                        {{ cell.selected_item.number }}
                    </span>
                {% endif %}
            </div>
        {% endfor %}
    </div>
    <h2>Vybraný blok</h2>
    <div class="sudoku-block">
        {% for cell in selected_block %}
            <div class="block-cell
                {% if cell.prefilled %} locked{% endif %}
                {% if cell.selected_item and cell.is_correct %} correct{% endif %}
                {% if cell.selected_item and not cell.is_correct %} incorrect{% endif %}"
                {% if not cell.prefilled %}
                    onclick="placeItem({{ cell.id }}, {% if cell.selected_item %}{{ cell.selected_item.number }}{% else %}-1{% endif %})"
                {% endif %}>

                {% if cell.selected_item %}
                    {{ block_item_names|get_item:cell.selected_item.number|default:cell.selected_item.number }}
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <h2>Vyber předmět v místnosti: {{ room_name }}</h2>
    <div>
        {% for item in items %}
            <button class="item-btn" data-number="{{ item.number }}" onclick="selectItem({{ item.number }})">
                {{ item.name }}
            </button>
        {% endfor %}
    </div>

    <div class="block-selector">
        <p>Vyber blok:</p>
        {% for i in block_range %}
            <a href="#" onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id i %}')" class="{% if i == block_index %}active{% endif %}">
                Blok {{ i }}
            </a>
        {% endfor %}
    </div>

    <a href="{% url 'start_new_game' %}" onclick="return confirmNewGame();">
        Spustit novou hru
    </a>

    <button onclick="transitionTo('/gameplay/{{ game.id }}/block/1/')">TEST FADE</button>
    <button onclick="showQuote()">Zobraz citaci</button>

</div>

<script>
    let selectedNumber = null;

    function selectItem(number) {
        selectedNumber = number;
        document.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('selected'));
        document.querySelectorAll(`.item-btn[data-number="${number}"]`).forEach(btn => btn.classList.add('selected'));
    }

    function placeItem(cellId, currentItemNumber) {
        let numberToSend = selectedNumber !== null ? selectedNumber : -1;

        if (currentItemNumber === selectedNumber) {
            numberToSend = -1;
        }

        fetch(`/gameplay/place/${cellId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ number: numberToSend })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "completed") {
                window.location.href = "/gameplay/win/";
            } else {
                location.reload();
            }
        })
        .catch(error => console.error("Error communicating with server:", error));
    }

    function confirmNewGame() {
        return confirm("⚠️ Opravdu chceš spustit novou hru? Tvoje aktuální hra bude smazána!");
    }
</script>
{% endblock %}
