{% extends "base.html" %}
{% load custom_filters %}
{% load static %}

{% block title %}Hra {{ game.id }}{% endblock %}

{% block content %}
<!-- Overlay pro citace -->
<div id="quote-overlay" class="hidden">
    <div class="quote-text">‚ÄûNa poƒç√°tku bylo Slovo‚Ä¶‚Äú ‚Äì Jan 1:1</div>
</div>

<script>
    function showQuote() {
        const overlay = document.getElementById('quote-overlay');
        const quote = overlay.querySelector('.quote-text');

        overlay.classList.add('visible');
        setTimeout(() => quote.style.opacity = 1, 1500);
        setTimeout(() => quote.style.opacity = 0, 4500);
        setTimeout(() => overlay.classList.remove('visible'), 6000);
    }
</script>

<h2 class="room-name">
    {% for room in room_links %}
        {% if forloop.counter0 == block_index %}
            {{ room.name }}
        {% endif %}
    {% endfor %}
</h2>

<div class="game-wrapper">
    <!-- Wrapper pro Invent√°≈ô -->
    <div class="inventory-wrapper">
        <h3>Invent√°≈ô</h3>
        <div class="inventory">
            {% for item in items %}
                <div class="inventory-item">
                   <button class="item-btn" data-number="{{ item.number }}" onclick="selectItem({{ item.number }})">
                        {{ item.name }}
                   </button>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Wrapper pro Blok m√≠stnosti a Minimapu -->
    <div class="block-wrapper">
        <div class="sudoku-grid">
            {% for cell in cells %}
                <div class="cell
                    {% if cell.column in grid_borders %} grid-border{% endif %}
                    {% if cell.row in grid_borders %} grid-border{% endif %}">
                    {% if cell.selected_item %}
                        {% if game.difficulty == 'easy' %}
                            <span class="{% if cell.is_correct %}correct-number{% else %}incorrect-number{% endif %}">
                                {{ cell.selected_item.number }}
                            </span>
                        {% else %}
                            <span class="neutral-number">
                                {{ cell.selected_item.number }}
                            </span>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>
        <!-- Minimapa m√≠stnosti -->
        <div class="room-minimap">
            {% for i in block_range %}
                <div class="miniroom {% if i == block_index %}active{% endif %}" data-block="{{ i }}"></div>
            {% endfor %}
        </div>

        <!-- Wrapper pro Sudoku blok a dve≈ôe -->
        <div class="block-with-doors-wrapper">

            <div class="block-with-doors">
                <!-- Dve≈ôe mezi m√≠stnostmi -->
                <div class="door up">
                    {% if neighbors.up is not None %}
                <a href="#"
                   data-block="{{ neighbors.up.index }}"
                   onmouseover="highlightRoom({{ neighbors.up.index }})"
                   onmouseout="unhighlightRoom({{ neighbors.up.index }})"
                   onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id neighbors.up.index %}')">
                   üîº {{ neighbors.up.name }}
                </a>
                    {% endif %}
                </div>

                <div class="door left">
                    {% if neighbors.left is not None %}
                <a href="#"
                   data-block="{{ neighbors.left.index }}"
                   onmouseover="highlightRoom({{ neighbors.left.index }})"
                   onmouseout="unhighlightRoom({{ neighbors.left.index }})"
                   onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id neighbors.left.index %}')">
                    ‚óÄÔ∏è {{ neighbors.left.name }}
                </a>
                    {% endif %}
                </div>


                <div class="sudoku-block">
                    {% for cell in selected_block %}
                        <div class="block-cell {% if cell.prefilled %}locked{% if game.difficulty == 'easy' %} correct {% else %} prefilled-gray {% endif %} {% else %}{% if cell.selected_item %}{% if game.difficulty == 'easy' %}{% if cell.is_correct %} correct {% else %} incorrect {% endif %}{% else %} filled {% endif %}{% endif %}{% endif %}"
                             {% if not cell.prefilled %}
                                onclick="placeItem({{ cell.id }}, {% if cell.selected_item %}{{ cell.selected_item.number }}{% else %}-1{% endif %})"
                             {% endif %}>
                            {% if cell.selected_item %}
                                {{ block_item_names|get_item:cell.selected_item.number|default:cell.selected_item.number }}
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                <div class="door right">
                    {% if neighbors.right is not None %}
                <a href="#"
                   data-block="{{ neighbors.right.index }}"
                   onmouseover="highlightRoom({{ neighbors.right.index }})"
                   onmouseout="unhighlightRoom({{ neighbors.right.index }})"
                   onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id neighbors.right.index %}')">
                    ‚ñ∂Ô∏è {{ neighbors.right.name }}
                </a>
                    {% endif %}
                </div>

                <div class="door down">
                    {% if neighbors.down is not None %}
                <a href="#"
                   data-block="{{ neighbors.down.index }}"
                   onmouseover="highlightRoom({{ neighbors.down.index }})"
                   onmouseout="unhighlightRoom({{ neighbors.down.index }})"
                   onclick="event.preventDefault(); transitionTo('{% url 'game_block' game.id neighbors.down.index %}')">
                                            üîΩ {{ neighbors.down.name }}
                </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedNumber = null;

// Funkce pro v√Ωbƒõr polo≈æky z invent√°≈ôe
function selectItem(number) {
    console.log("Item selected: " + number);  // Kontrola v konzoli

    // Zru≈°√≠me v√Ωbƒõr z ostatn√≠ch polo≈æek
    document.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('selected'));

    // P≈ôid√°me t≈ô√≠du 'selected' k tlaƒç√≠tku, kter√© bylo kliknuto
    const selectedButton = document.querySelector(`.item-btn[data-number="${number}"]`);
    if (selectedButton) {
        selectedButton.classList.add('selected');
    }

    // Nastav√≠me ƒç√≠slo vybran√© polo≈æky
    selectedNumber = number;
}

// Funkce pro um√≠stƒõn√≠ polo≈æky na m≈ô√≠≈æku
function placeItem(cellId, currentItemNumber) {
    console.log("Placing item:", selectedNumber, "on cell:", cellId); // Debugging

    let numberToSend = selectedNumber !== null ? selectedNumber : -1;

    // Zkontrolujte, zda ƒç√≠slo polo≈æky je stejn√© jako ji≈æ um√≠stƒõn√° polo≈æka, a p≈ô√≠padnƒõ polo≈æku zru≈°te
    if (currentItemNumber === selectedNumber) {
        numberToSend = -1;
    }

    // Odesl√°n√≠ po≈æadavku na server
    fetch(`/gameplay/place/${cellId}/`, {
        method: "POST",
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ number: numberToSend })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data); // Debugging
        if (data.status === "completed") {
            window.location.href = "/gameplay/win/";
        } else {
            location.reload(); // Reload the page to update state
        }
    })
    .catch(error => console.error("Error communicating with server:", error));
}
    function highlightRoom(index) {
        const mini = document.querySelector(`.miniroom[data-block='${index}']`);
        if (mini) mini.classList.add('highlighted');
    }

    function unhighlightRoom(index) {
        const mini = document.querySelector(`.miniroom[data-block='${index}']`);
        if (mini) mini.classList.remove('highlighted');
    }
</script>

{% endblock %}

