{% extends "base.html" %}
{% load static %}

{% block title %}Hra {{ game.id }}{% endblock %}

{% block content %}
<div class="game-wrapper">

    <h1>Hra id: {{ game.id }}</h1>
    <p>Hráč: {{ game.player.username }}</p>

    <h2>Vyber předmět</h2>
    <div>
        {% for item in items %}
            <button id="item-{{ item.id }}" class="item-btn" onclick="selectItem({{ item.id }})">
                {{ item.number }} - {{ item.name }}
            </button>
        {% endfor %}
    </div>

    <h2>Herní mřížka</h2>
    <div class="sudoku-grid">
        {% for cell in cells %}
            <div class="cell
                {% if cell.column in grid_borders %} grid-border{% endif %}
                {% if cell.row in grid_borders %} grid-border{% endif %}">
                {% if cell.selected_item %}
                    <span class="{% if cell.selected_item and cell.is_correct %} correct-number{% elif cell.selected_item and not cell.is_correct %} incorrect-number{% endif %}">
                        {{ cell.selected_item.number }}
                    </span>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <h2>Vybraný blok</h2>
    <div class="sudoku-block">
        {% for cell in selected_block %}
            <div class="block-cell
                {% if cell.selected_item and cell.is_correct %} correct{% endif %}
                {% if cell.selected_item and not cell.is_correct %} incorrect{% endif %}"
                onclick="placeItem({{ cell.id }}, {% if cell.selected_item %}{{ cell.selected_item.id }}{% else %}-1{% endif %})">
                {{ cell.selected_item.number|default:"" }} - {{ cell.selected_item.name|default:"" }}
            </div>
        {% endfor %}
    </div>

    <div class="block-selector">
        <p>Vyber blok:</p>
        {% for i in block_range %}
            <a href="{% url 'game_block' game.id i %}" class="{% if i == block_index %}active{% endif %}">
                Blok {{ i }}
            </a>
        {% endfor %}
    </div>

    <a href="{% url 'start_new_game' %}" onclick="return confirmNewGame();">
        Spustit novou hru
    </a>

</div>

<script>
    let selectedItem = null;

    function selectItem(itemId) {
        selectedItem = itemId;
        document.querySelectorAll('.item-btn').forEach(btn => btn.classList.remove('selected'));
        document.getElementById('item-' + itemId).classList.add('selected');
    }

    function placeItem(cellId, currentItemId) {
        let itemToSend = selectedItem !== null ? selectedItem : -1;

        if (currentItemId === selectedItem) {
            itemToSend = -1;
        }

        fetch(`/gameplay/place/${cellId}/`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
            },
            body: JSON.stringify({ item_id: itemToSend })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "completed") {
                window.location.href = "/gameplay/win/";
            } else {
                location.reload();
            }
        })
        .catch(error => console.error("Error communicating with server:", error));
    }

    function confirmNewGame() {
        return confirm("⚠️ Opravdu chceš spustit novou hru? Tvoje aktuální hra bude smazána!");
    }
</script>
{% endblock %}